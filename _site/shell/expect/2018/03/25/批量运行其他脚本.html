<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="http://www.jq22.com/jquery/bootstrap-3.3.4.css">
	<link rel="stylesheet" href="/css/index.css">
    <script src="/js/love.js"></script>
</head>
<body>
	
	<div id="wrapper">
        <div class="overlay"></div>
    
        <!-- Sidebar -->
        <nav class="navbar navbar-inverse navbar-fixed-top" id="sidebar-wrapper" role="navigation">
            <ul class="nav sidebar-nav">
                <li class="sidebar-brand">
                    <a href="#">
                       Bootstrap 3
                    </a>
                </li>
            </ul>
        </nav>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
          <button type="button" class="hamburger is-closed animated fadeInLeft" data-toggle="offcanvas">
            <span class="hamb-top"></span>
            <span class="hamb-middle"></span>
            <span class="hamb-bottom"></span>
          </button>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">

                <div>
	<div>
		<h1>批量运行其他脚本</h1>
		<div>
			25 Mar 2018 • 晴天
		</div>
	</div>
	<hr>
	<article>
		<p>为了能在多台主机上，执行检查脚本，所以写了这个脚本</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="c"># author wangtw</span>
<span class="nv">shelldir</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="sb">`</span><span class="nb">dirname</span> <span class="nv">$0</span><span class="sb">`</span><span class="p">;</span> <span class="nb">pwd</span><span class="k">)</span>
<span class="nv">inifile</span><span class="o">=</span><span class="nv">$shelldir</span>/ruleCheckHosts.ini<span class="p">;</span>

<span class="nv">zkRuleHosts</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$inifile</span>|grep ^zkRuleHost|awk <span class="nt">-F</span> <span class="o">=</span> <span class="s1">'{print $2}'</span>|tr <span class="nt">-d</span> <span class="s1">'\r'</span><span class="sb">`</span>
<span class="nv">zkRuleCheckSh</span><span class="o">=</span>1

<span class="nv">redisHosts</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$inifile</span>|grep ^redisHost|awk <span class="nt">-F</span> <span class="o">=</span> <span class="s1">'{print $2}'</span>|tr <span class="nt">-d</span> <span class="s1">'\r'</span><span class="sb">`</span>
<span class="nv">redisCheckSh</span><span class="o">=</span>2

<span class="nv">redisKafkaZkHosts</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$inifile</span>|grep ^redisKafkaZkHost|awk <span class="nt">-F</span> <span class="o">=</span> <span class="s1">'{print $2}'</span>|tr <span class="nt">-d</span> <span class="s1">'\r'</span><span class="sb">`</span>
<span class="nv">redisKafkaZkCheckSh</span><span class="o">=</span>3

<span class="nv">nimbusHosts</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$inifile</span>|grep ^nimbusHost|awk <span class="nt">-F</span> <span class="o">=</span> <span class="s1">'{print $2}'</span>|tr <span class="nt">-d</span> <span class="s1">'\r'</span><span class="sb">`</span>
<span class="nv">nimbusCheckSh</span><span class="o">=</span>4

<span class="nv">supervisorHosts</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$inifile</span>|grep ^supervisorHost|awk <span class="nt">-F</span> <span class="o">=</span> <span class="s1">'{print $2}'</span>|tr <span class="nt">-d</span> <span class="s1">'\r'</span><span class="sb">`</span>
<span class="nv">supervisorCheckSh</span><span class="o">=</span>5

<span class="k">for </span>host <span class="k">in</span> <span class="nv">$zkRuleHosts</span>
	<span class="k">do</span>
		./start_rulecheck.exp <span class="nv">$host</span> <span class="nv">$zkRuleCheckSh</span>
	<span class="k">done
for </span>host <span class="k">in</span> <span class="nv">$redisHosts</span>
	<span class="k">do</span>
		./start_rulecheck.exp <span class="nv">$host</span> <span class="nv">$redisCheckSh</span>
	<span class="k">done
for </span>host <span class="k">in</span> <span class="nv">$redisKafkaZkHosts</span> 
	<span class="k">do</span>
		./start_rulecheck.exp <span class="nv">$host</span> <span class="nv">$redisKafkaZkCheckSh</span>
	<span class="k">done
for </span>host <span class="k">in</span> <span class="nv">$nimbusHosts</span>
	<span class="k">do</span>
		./start_rulecheck.exp <span class="nv">$host</span> <span class="nv">$nimbusCheckSh</span>
	<span class="k">done
for </span>host <span class="k">in</span> <span class="nv">$supervisorHosts</span>
	<span class="k">do</span>
		./start_rulecheck.exp <span class="nv">$host</span> <span class="nv">$supervisorCheckSh</span>
	<span class="k">done</span>
</code></pre></div></div>

<p>考虑到不同主机，需要执行不同脚本。本来打算传入一个存放执行脚本名的数组，但在遍历时出现问题，所以写了不同的情况，显得繁琐。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/usr/bin/expect -f
set targetIp [lindex $argv 0 0]
set ruleCheckSh [lindex $argv 1 end]
if { "$ruleCheckSh" == 2 } {
	spawn ssh log@$targetIp
	expect {
		"yes/no" {
			send "yes\r"
			expect "password:" { send "log\r" }
		}
		"password:" { send "log\r" }
	}
	expect "\]\\\$" { send "cd rulecheck\r" }
	expect "\]\\\$" { send "./rulecheckredis.sh\r"}
	expect "\]\\\$" { send "exit\r"}
} elseif { "$ruleCheckSh" == 3 } {
	spawn ssh log@$targetIp
	expect {
		"yes/no" {
			send "yes\r"
			expect "password:" { send "log\r" }
		}
		"password:" { send "log\r" }
	}
	expect "\]\\\$" { send "cd rulecheck\r" }
	expect "\]\\\$" { send "./rulecheck-kafka-zookeeper.sh\r"}
	expect "\]\\\$" { send "./rulecheckiot-iotlog-data.sh\r"}
	expect "\]\\\$" { send "exit\r"}
} elseif { "$ruleCheckSh" == 4 } {
	spawn ssh log@$targetIp
	expect {
		"yes/no" {
			send "yes\r"
			expect "password:" { send "log\r" }
		}
		"password:" { send "log\r" }
	}
	expect "\]\\\$" { send "cd rulecheck\r" }
	expect "\]\\\$" { send "./rulechecknimbus.sh\r"}
	expect "\]\\\$" { send "./rulecheckiot-iotlog-data.sh\r"}
	expect "\]\\\$" { send "exit\r"}
} elseif { "$ruleCheckSh" == 5 } {
	spawn ssh log@$targetIp
	expect {
		"yes/no" {
			send "yes\r"
			expect "password:" { send "log\r" }
		}
		"password:" { send "log\r" }
	}
	expect "\]\\\$" { send "cd rulecheck\r" }
	expect "\]\\\$" { send "./rulechecksupervisor.sh\r"}
	expect "\]\\\$" { send "./rulecheckiot-iotlog-data.sh\r"}
	expect "\]\\\$" { send "exit\r"}
} elseif { "$ruleCheckSh" == 1 } {
	spawn ssh log@$targetIp
	expect {
		"yes/no" {
			send "yes\r"
			expect "password:" { send "log\r" }
		}
		"password:" { send "log\r" }
	}
	expect "\]\\\$" { send "cd rulecheck\r" }
	expect "\]\\\$" { send "./rulecheckzookeeper.sh\r"}
	expect "\]\\\$" { send "exit\r"}
}





</code></pre></div></div>


	</article>
	<hr>
</div>

                    </div>
                </div>
            </div>
        </div>
        <!-- /#page-content-wrapper -->

    </div>
    <!-- /#wrapper -->
	
	<script src="http://www.jq22.com/jquery/jquery-1.10.2.js"></script>
	<script src="http://www.jq22.com/jquery/bootstrap-3.3.4.js"></script>
	<script type="text/javascript">
		$(document).ready(function () {
		  var trigger = $('.hamburger'),
		      overlay = $('.overlay'),
		     isClosed = false;

		    trigger.click(function () {
		      hamburger_cross();      
		    });

		    function hamburger_cross() {

		      if (isClosed == true) {          
		        overlay.hide();
		        trigger.removeClass('is-open');
		        trigger.addClass('is-closed');
		        isClosed = false;
		      } else {   
		        overlay.show();
		        trigger.removeClass('is-closed');
		        trigger.addClass('is-open');
		        isClosed = true;
		      }
		  }
		  
		  $('[data-toggle="offcanvas"]').click(function () {
		        $('#wrapper').toggleClass('toggled');
		  });  
		});
	</script>
</body>
</html>